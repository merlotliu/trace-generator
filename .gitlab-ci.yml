stages:
  - build
  - test
  - package
  - publish

variables:
  PACKAGE_VERSION: "1.0.0"
  DEBIAN_FRONTEND: noninteractive

# ==================== æ„å»ºé˜¶æ®µ ====================

build-python:
  stage: build
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y git
    - pip install build pytest
  script:
    - python -m build
    - pip install dist/*.whl
    - tracegen --help
  artifacts:
    paths:
      - dist/
    expire_in: 1 hour
  except:
    - tags

# ==================== æµ‹è¯•é˜¶æ®µ ====================

test-functionality:
  stage: test
  image: python:3.11-slim
  dependencies:
    - build-python
  script:
    - pip install dist/*.whl
    - python -c "import tracegen; print('âœ… Python æ¨¡å—å¯¼å…¥æˆåŠŸ')"
    - tracegen --help | grep "æ ‡å‡†æ ¼å¼ Trace ç”Ÿæˆå·¥å…·"
    - echo "âœ… åŠŸèƒ½æµ‹è¯•é€šè¿‡"
  except:
    - tags

# ==================== æ‰“åŒ…é˜¶æ®µ ====================

package-homebrew:
  stage: package
  image: alpine:latest
  before_script:
    - apk add --no-cache git bash coreutils
  script:
    # åˆ›å»º GitHub tarball
    - git archive --format=tar.gz --prefix=tracegen-v${PACKAGE_VERSION}/ HEAD > tracegen-v${PACKAGE_VERSION}.tar.gz
    
    # è®¡ç®— SHA256
    - SHA256=$(sha256sum tracegen-v${PACKAGE_VERSION}.tar.gz | cut -d' ' -f1)
    - echo "è®¡ç®—çš„ SHA256: $SHA256"
    - echo "SHA256=$SHA256" > homebrew.env
    
    # æ›´æ–° Formula ä¸­çš„ SHA256
    - sed -i "s/SHA256_FROM_GITLAB_RELEASE/$SHA256/g" Formula/tracegen.rb
    
    # éªŒè¯ Formula
    - echo "=== æ›´æ–°åçš„ Formula ==="
    - cat Formula/tracegen.rb
  artifacts:
    paths:
      - tracegen-v${PACKAGE_VERSION}.tar.gz
      - Formula/tracegen.rb
    reports:
      dotenv: homebrew.env
    expire_in: 1 week
  only:
    - tags

package-apt:
  stage: package
  image: ubuntu:22.04
  before_script:
    - apt-get update
    - apt-get install -y debhelper devscripts build-essential python3-dev 
    - apt-get install -y rustc cargo cmake pkg-config
    - apt-get install -y python3-setuptools python3-pip dh-python
  script:
    # å‡†å¤‡æ„å»ºç¯å¢ƒ
    - export DEBEMAIL="liumoulu@lixiang.com"
    - export DEBFULLNAME="åˆ˜æŸæŸ"
    
    # æ„å»º deb åŒ…
    - echo "=== å¼€å§‹æ„å»º APT åŒ… ==="
    - debuild -us -uc -b
    
    # ç§»åŠ¨ç”Ÿæˆçš„åŒ…
    - mv ../tracegen_${PACKAGE_VERSION}*.deb .
    - ls -la *.deb
    
    # éªŒè¯åŒ…ä¿¡æ¯
    - dpkg-deb --info tracegen_${PACKAGE_VERSION}*.deb
    - dpkg-deb --contents tracegen_${PACKAGE_VERSION}*.deb
  artifacts:
    paths:
      - "*.deb"
    expire_in: 1 week
  only:
    - tags

# ==================== å‘å¸ƒé˜¶æ®µ ====================

publish-homebrew:
  stage: publish
  image: alpine:latest
  dependencies:
    - package-homebrew
  before_script:
    - apk add --no-cache git openssh-client
    # é…ç½® Gitï¼ˆå‡è®¾æœ‰éƒ¨ç½²å¯†é’¥ï¼‰
    - mkdir -p ~/.ssh
    - echo "$HOMEBREW_DEPLOY_KEY" | base64 -d > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan gitlab.lixiang.com >> ~/.ssh/known_hosts
    - git config --global user.email "ci@lixiang.com"
    - git config --global user.name "CI Bot"
  script:
    # å…‹éš† Homebrew Tap ä»“åº“
    - git clone git@gitlab.lixiang.com:homebrew/tap.git homebrew-tap
    
    # æ›´æ–° Formula
    - cp Formula/tracegen.rb homebrew-tap/Formula/
    
    # æäº¤å¹¶æ¨é€
    - cd homebrew-tap
    - git add Formula/tracegen.rb
    - git commit -m "ğŸš€ Update tracegen to v${PACKAGE_VERSION}"
    - git push origin main
    
    - echo "âœ… Homebrew Formula å‘å¸ƒæˆåŠŸ"
    - echo "ç”¨æˆ·å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š"
    - echo "brew tap lixiang/tools git@gitlab.lixiang.com:homebrew/tap.git"
    - echo "brew install tracegen"
  only:
    - tags
  when: manual  # éœ€è¦æ‰‹åŠ¨è§¦å‘

publish-apt:
  stage: publish
  image: ubuntu:22.04
  dependencies:
    - package-apt
  before_script:
    - apt-get update && apt-get install -y curl
  script:
    # ä¸Šä¼ åˆ°å†…éƒ¨ APT ä»“åº“ï¼ˆéœ€è¦é…ç½®ç›¸åº”çš„ä¸Šä¼ æ¥å£ï¼‰
    - echo "=== å‘å¸ƒ APT åŒ… ==="
    - DEB_FILE=$(ls tracegen_${PACKAGE_VERSION}*.deb)
    - echo "å‡†å¤‡ä¸Šä¼ : $DEB_FILE"
    
    # ç¤ºä¾‹ï¼šé€šè¿‡ HTTP API ä¸Šä¼ åˆ°å†…éƒ¨ APT ä»“åº“
    # - curl -F "file=@$DEB_FILE" -H "Authorization: Bearer $APT_REPO_TOKEN" https://apt.lixiang.com/upload
    
    # æˆ–è€…é€šè¿‡ SCP ä¸Šä¼ åˆ°æœåŠ¡å™¨
    # - scp $DEB_FILE deploy@apt-server:/var/www/apt/incoming/
    
    - echo "âœ… APT åŒ…å‘å¸ƒæˆåŠŸ"
    - echo "ç”¨æˆ·å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š"
    - echo "echo 'deb https://apt.lixiang.com/ubuntu jammy main' | sudo tee /etc/apt/sources.list.d/lixiang.list"
    - echo "sudo apt update && sudo apt install tracegen"
  only:
    - tags
  when: manual  # éœ€è¦æ‰‹åŠ¨è§¦å‘

# ==================== å‘å¸ƒç‰ˆæœ¬ä¿¡æ¯ ====================

release-notes:
  stage: publish
  image: alpine:latest
  dependencies:
    - package-homebrew
    - package-apt
  script:
    - echo "=== Tracegen v${PACKAGE_VERSION} å‘å¸ƒæˆåŠŸ ==="
    - echo ""
    - echo "ğŸ“¦ å¯ç”¨å®‰è£…æ–¹å¼ï¼š"
    - echo ""
    - echo "ğŸº macOS (Homebrew):"
    - echo "  brew tap lixiang/tools git@gitlab.lixiang.com:homebrew/tap.git"
    - echo "  brew install tracegen"
    - echo ""
    - echo "ğŸ§ Ubuntu/WSL (APT):"
    - echo "  echo 'deb https://apt.lixiang.com/ubuntu jammy main' | sudo tee /etc/apt/sources.list.d/lixiang.list"
    - echo "  sudo apt update && sudo apt install tracegen"
    - echo ""
    - echo "ğŸ“‹ ä½¿ç”¨ç¤ºä¾‹ï¼š"
    - echo "  tracegen -v HLX33B121R1647380 -s '2025-02-06 21:40:14' -e '2025-02-06 22:10:14' -t short -t gfx"
  only:
    - tags 